<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Data Chart Test</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        #chart {
            width: 90%;
            height: 600px;
            border: 1px solid #374151;
            border-radius: 8px;
            overflow: hidden;
        }

        .info {
            margin-bottom: 1rem;
            text-align: center;
        }

        .legend {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div class="info">
        <h2 id="title">Loading...</h2>
        <p id="details"></p>
        <div style="margin-top: 10px;">
            <label for="timeframe">Timeframe: </label>
            <select id="timeframe"
                style="background: #374151; color: white; border: 1px solid #4B5563; padding: 4px 8px; border-radius: 4px;">
                <option value="5">M5</option>
                <option value="15">M15</option>
                <option value="60">H1</option>
                <option value="240">H4</option>
            </select>
        </div>
    </div>
    <div id="chart"></div>

    <div class="legend">
        <div class="legend-item">
            <div class="dot" style="background: #3B82F6;"></div> Entry
        </div>
        <div class="legend-item">
            <div class="dot" style="background: #10B981;"></div> TP
        </div>
        <div class="legend-item">
            <div class="dot" style="background: #EF4444;"></div> SL
        </div>
    </div>

    <script>
        // Raw Data from Python Script
        const rawData = {
            "trade": { "id": "fffdecbe-de92-4d8b-aa06-999eb04ad708", "participant_id": "ea0129ad-7224-476b-9873-59cb1819db21", "symbol": "XAUUSD.s", "type": "SELL", "lot_size": 0.01, "open_price": 4193.09, "close_price": 4197.05, "open_time": "2025-12-04T13:26:51+00:00", "close_time": "2025-12-04T13:29:36+00:00", "profit": -3.96, "created_at": "2025-12-04T13:47:09.53606+00:00", "position_id": 14892025, "sl": 4197.0, "tp": 4187.0 }, "candles": [{ "symbol": "XAUUSD", "time": "2025-12-03T13:30:00+00:00", "open": 4220.3, "high": 4225.65, "low": 4216.89, "close": 4223.58, "volume": 5601 }, { "symbol": "XAUUSD", "time": "2025-12-03T13:45:00+00:00", "open": 4223.53, "high": 4238.32, "low": 4222.32, "close": 4236.73, "volume": 5530 }, { "symbol": "XAUUSD", "time": "2025-12-03T14:00:00+00:00", "open": 4236.78, "high": 4240.8, "low": 4218.81, "close": 4226.59, "volume": 7396 }, { "symbol": "XAUUSD", "time": "2025-12-03T14:15:00+00:00", "open": 4226.63, "high": 4230.77, "low": 4221.45, "close": 4224.57, "volume": 6100 }, { "symbol": "XAUUSD", "time": "2025-12-03T14:30:00+00:00", "open": 4224.53, "high": 4241.34, "low": 4223.64, "close": 4226.95, "volume": 7572 }, { "symbol": "XAUUSD", "time": "2025-12-03T14:45:00+00:00", "open": 4227.01, "high": 4227.01, "low": 4205.15, "close": 4212.39, "volume": 7279 }, { "symbol": "XAUUSD", "time": "2025-12-03T15:00:00+00:00", "open": 4212.66, "high": 4219.11, "low": 4206.12, "close": 4217.39, "volume": 6919 }, { "symbol": "XAUUSD", "time": "2025-12-03T15:15:00+00:00", "open": 4217.4, "high": 4224.23, "low": 4216.27, "close": 4221.55, "volume": 6019 }, { "symbol": "XAUUSD", "time": "2025-12-03T15:30:00+00:00", "open": 4221.57, "high": 4229.18, "low": 4220.86, "close": 4227.34, "volume": 5707 }, { "symbol": "XAUUSD", "time": "2025-12-03T15:45:00+00:00", "open": 4227.36, "high": 4227.89, "low": 4214.21, "close": 4216.32, "volume": 6098 }, { "symbol": "XAUUSD", "time": "2025-12-03T16:00:00+00:00", "open": 4216.31, "high": 4221.93, "low": 4214.18, "close": 4219.52, "volume": 5797 }, { "symbol": "XAUUSD", "time": "2025-12-03T16:15:00+00:00", "open": 4219.48, "high": 4219.51, "low": 4212.72, "close": 4219.02, "volume": 5411 }, { "symbol": "XAUUSD", "time": "2025-12-03T16:30:00+00:00", "open": 4219.16, "high": 4225.06, "low": 4218.41, "close": 4220.63, "volume": 5780 }, { "symbol": "XAUUSD", "time": "2025-12-03T16:45:00+00:00", "open": 4220.43, "high": 4220.94, "low": 4195.75, "close": 4200.81, "volume": 6853 }, { "symbol": "XAUUSD", "time": "2025-12-03T17:00:00+00:00", "open": 4200.82, "high": 4212.44, "low": 4200.16, "close": 4211.0, "volume": 6136 }, { "symbol": "XAUUSD", "time": "2025-12-03T17:15:00+00:00", "open": 4210.99, "high": 4212.99, "low": 4207.67, "close": 4208.9, "volume": 4892 }, { "symbol": "XAUUSD", "time": "2025-12-03T17:30:00+00:00", "open": 4208.88, "high": 4215.42, "low": 4207.93, "close": 4212.51, "volume": 4653 }, { "symbol": "XAUUSD", "time": "2025-12-03T17:45:00+00:00", "open": 4212.62, "high": 4214.54, "low": 4208.26, "close": 4211.05, "volume": 4601 }, { "symbol": "XAUUSD", "time": "2025-12-03T18:00:00+00:00", "open": 4211.07, "high": 4211.47, "low": 4202.05, "close": 4204.49, "volume": 5498 }, { "symbol": "XAUUSD", "time": "2025-12-03T18:15:00+00:00", "open": 4204.52, "high": 4206.35, "low": 4198.44, "close": 4201.72, "volume": 5804 }, { "symbol": "XAUUSD", "time": "2025-12-03T18:30:00+00:00", "open": 4201.71, "high": 4206.68, "low": 4200.08, "close": 4205.02, "volume": 4561 }, { "symbol": "XAUUSD", "time": "2025-12-03T18:45:00+00:00", "open": 4205.01, "high": 4205.75, "low": 4194.99, "close": 4196.77, "volume": 4673 }, { "symbol": "XAUUSD", "time": "2025-12-03T19:00:00+00:00", "open": 4196.8, "high": 4203.8, "low": 4196.76, "close": 4201.1, "volume": 4617 }, { "symbol": "XAUUSD", "time": "2025-12-03T19:15:00+00:00", "open": 4201.08, "high": 4206.66, "low": 4200.88, "close": 4206.05, "volume": 4251 }, { "symbol": "XAUUSD", "time": "2025-12-03T19:30:00+00:00", "open": 4206.05, "high": 4209.8, "low": 4204.88, "close": 4208.79, "volume": 3749 }, { "symbol": "XAUUSD", "time": "2025-12-03T19:45:00+00:00", "open": 4208.77, "high": 4209.95, "low": 4207.69, "close": 4207.8, "volume": 3253 }, { "symbol": "XAUUSD", "time": "2025-12-03T20:00:00+00:00", "open": 4207.76, "high": 4212.82, "low": 4207.48, "close": 4211.13, "volume": 3465 }, { "symbol": "XAUUSD", "time": "2025-12-03T20:15:00+00:00", "open": 4211.15, "high": 4211.4, "low": 4208.09, "close": 4210.06, "volume": 3016 }, { "symbol": "XAUUSD", "time": "2025-12-03T20:30:00+00:00", "open": 4210.08, "high": 4210.78, "low": 4207.56, "close": 4208.58, "volume": 4284 }, { "symbol": "XAUUSD", "time": "2025-12-03T20:45:00+00:00", "open": 4208.57, "high": 4208.77, "low": 4206.0, "close": 4206.68, "volume": 3761 }, { "symbol": "XAUUSD", "time": "2025-12-03T23:00:00+00:00", "open": 4203.9, "high": 4207.56, "low": 4203.9, "close": 4206.56, "volume": 1362 }, { "symbol": "XAUUSD", "time": "2025-12-03T23:15:00+00:00", "open": 4206.55, "high": 4208.89, "low": 4206.17, "close": 4206.99, "volume": 1407 }, { "symbol": "XAUUSD", "time": "2025-12-03T23:30:00+00:00", "open": 4207.08, "high": 4207.2, "low": 4203.87, "close": 4206.1, "volume": 1748 }, { "symbol": "XAUUSD", "time": "2025-12-03T23:45:00+00:00", "open": 4205.97, "high": 4207.29, "low": 4202.66, "close": 4207.1, "volume": 1814 }, { "symbol": "XAUUSD", "time": "2025-12-04T00:00:00+00:00", "open": 4207.11, "high": 4210.39, "low": 4204.42, "close": 4207.68, "volume": 1889 }, { "symbol": "XAUUSD", "time": "2025-12-04T00:15:00+00:00", "open": 4207.67, "high": 4212.87, "low": 4206.49, "close": 4211.85, "volume": 2465 }, { "symbol": "XAUUSD", "time": "2025-12-04T00:30:00+00:00", "open": 4211.77, "high": 4215.78, "low": 4211.09, "close": 4213.46, "volume": 3580 }, { "symbol": "XAUUSD", "time": "2025-12-04T00:45:00+00:00", "open": 4213.48, "high": 4213.88, "low": 4209.35, "close": 4211.64, "volume": 3608 }, { "symbol": "XAUUSD", "time": "2025-12-04T01:00:00+00:00", "open": 4211.62, "high": 4213.94, "low": 4205.91, "close": 4213.6, "volume": 5937 }, { "symbol": "XAUUSD", "time": "2025-12-04T01:15:00+00:00", "open": 4213.68, "high": 4214.66, "low": 4210.36, "close": 4212.94, "volume": 5385 }, { "symbol": "XAUUSD", "time": "2025-12-04T01:30:00+00:00", "open": 4213.08, "high": 4214.79, "low": 4211.03, "close": 4214.76, "volume": 4478 }, { "symbol": "XAUUSD", "time": "2025-12-04T01:45:00+00:00", "open": 4214.74, "high": 4216.76, "low": 4207.7, "close": 4209.31, "volume": 4705 }, { "symbol": "XAUUSD", "time": "2025-12-04T02:00:00+00:00", "open": 4209.28, "high": 4209.31, "low": 4198.91, "close": 4204.76, "volume": 4624 }, { "symbol": "XAUUSD", "time": "2025-12-04T02:15:00+00:00", "open": 4204.74, "high": 4206.63, "low": 4202.57, "close": 4205.91, "volume": 2712 }, { "symbol": "XAUUSD", "time": "2025-12-04T02:30:00+00:00", "open": 4205.91, "high": 4207.42, "low": 4201.22, "close": 4201.47, "volume": 4675 }, { "symbol": "XAUUSD", "time": "2025-12-04T02:45:00+00:00", "open": 4201.46, "high": 4204.4, "low": 4199.66, "close": 4200.56, "volume": 4364 }, { "symbol": "XAUUSD", "time": "2025-12-04T03:00:00+00:00", "open": 4200.54, "high": 4201.52, "low": 4187.46, "close": 4193.13, "volume": 4742 }, { "symbol": "XAUUSD", "time": "2025-12-04T03:15:00+00:00", "open": 4193.11, "high": 4196.04, "low": 4192.02, "close": 4193.25, "volume": 4090 }, { "symbol": "XAUUSD", "time": "2025-12-04T03:30:00+00:00", "open": 4193.31, "high": 4197.04, "low": 4190.3, "close": 4196.9, "volume": 3155 }, { "symbol": "XAUUSD", "time": "2025-12-04T03:45:00+00:00", "open": 4196.99, "high": 4197.85, "low": 4193.72, "close": 4195.86, "volume": 3020 }, { "symbol": "XAUUSD", "time": "2025-12-04T04:00:00+00:00", "open": 4195.81, "high": 4197.48, "low": 4192.92, "close": 4197.21, "volume": 2567 }, { "symbol": "XAUUSD", "time": "2025-12-04T04:15:00+00:00", "open": 4197.3, "high": 4198.84, "low": 4195.56, "close": 4198.23, "volume": 2439 }, { "symbol": "XAUUSD", "time": "2025-12-04T04:30:00+00:00", "open": 4198.2, "high": 4198.5, "low": 4196.47, "close": 4197.17, "volume": 2584 }, { "symbol": "XAUUSD", "time": "2025-12-04T04:45:00+00:00", "open": 4197.15, "high": 4197.55, "low": 4194.71, "close": 4197.03, "volume": 3093 }, { "symbol": "XAUUSD", "time": "2025-12-04T05:00:00+00:00", "open": 4197.01, "high": 4197.94, "low": 4194.12, "close": 4194.12, "volume": 1944 }, { "symbol": "XAUUSD", "time": "2025-12-04T05:15:00+00:00", "open": 4194.16, "high": 4197.4, "low": 4189.54, "close": 4197.04, "volume": 3561 }, { "symbol": "XAUUSD", "time": "2025-12-04T05:30:00+00:00", "open": 4197.08, "high": 4198.99, "low": 4180.68, "close": 4184.1, "volume": 5945 }, { "symbol": "XAUUSD", "time": "2025-12-04T05:45:00+00:00", "open": 4184.09, "high": 4185.7, "low": 4175.06, "close": 4180.9, "volume": 5611 }, { "symbol": "XAUUSD", "time": "2025-12-04T06:00:00+00:00", "open": 4180.96, "high": 4185.65, "low": 4179.27, "close": 4180.34, "volume": 5061 }, { "symbol": "XAUUSD", "time": "2025-12-04T06:15:00+00:00", "open": 4180.43, "high": 4185.71, "low": 4178.67, "close": 4182.96, "volume": 6141 }, { "symbol": "XAUUSD", "time": "2025-12-04T06:30:00+00:00", "open": 4182.95, "high": 4189.13, "low": 4182.55, "close": 4188.77, "volume": 4685 }, { "symbol": "XAUUSD", "time": "2025-12-04T06:45:00+00:00", "open": 4188.7, "high": 4190.33, "low": 4187.0, "close": 4190.14, "volume": 3706 }, { "symbol": "XAUUSD", "time": "2025-12-04T07:00:00+00:00", "open": 4190.15, "high": 4192.18, "low": 4186.72, "close": 4192.17, "volume": 4068 }, { "symbol": "XAUUSD", "time": "2025-12-04T07:15:00+00:00", "open": 4192.24, "high": 4194.63, "low": 4188.57, "close": 4189.21, "volume": 3078 }, { "symbol": "XAUUSD", "time": "2025-12-04T07:30:00+00:00", "open": 4189.21, "high": 4191.75, "low": 4188.55, "close": 4189.58, "volume": 2950 }, { "symbol": "XAUUSD", "time": "2025-12-04T07:45:00+00:00", "open": 4189.57, "high": 4194.02, "low": 4186.63, "close": 4193.92, "volume": 3550 }, { "symbol": "XAUUSD", "time": "2025-12-04T08:00:00+00:00", "open": 4193.94, "high": 4195.43, "low": 4189.73, "close": 4191.32, "volume": 4427 }, { "symbol": "XAUUSD", "time": "2025-12-04T08:15:00+00:00", "open": 4191.29, "high": 4196.35, "low": 4191.13, "close": 4192.7, "volume": 4318 }, { "symbol": "XAUUSD", "time": "2025-12-04T08:30:00+00:00", "open": 4192.74, "high": 4194.41, "low": 4190.75, "close": 4190.76, "volume": 4650 }, { "symbol": "XAUUSD", "time": "2025-12-04T08:45:00+00:00", "open": 4190.79, "high": 4192.55, "low": 4184.77, "close": 4184.77, "volume": 4298 }, { "symbol": "XAUUSD", "time": "2025-12-04T09:00:00+00:00", "open": 4184.7, "high": 4191.42, "low": 4183.62, "close": 4189.52, "volume": 4853 }, { "symbol": "XAUUSD", "time": "2025-12-04T09:15:00+00:00", "open": 4189.53, "high": 4192.0, "low": 4187.59, "close": 4191.35, "volume": 3861 }, { "symbol": "XAUUSD", "time": "2025-12-04T09:30:00+00:00", "open": 4191.33, "high": 4198.03, "low": 4190.65, "close": 4197.05, "volume": 2820 }, { "symbol": "XAUUSD", "time": "2025-12-04T09:45:00+00:00", "open": 4197.03, "high": 4202.27, "low": 4196.44, "close": 4199.78, "volume": 3555 }, { "symbol": "XAUUSD", "time": "2025-12-04T10:00:00+00:00", "open": 4199.78, "high": 4202.63, "low": 4198.92, "close": 4199.61, "volume": 3239 }, { "symbol": "XAUUSD", "time": "2025-12-04T10:15:00+00:00", "open": 4199.62, "high": 4202.36, "low": 4198.31, "close": 4199.13, "volume": 3129 }, { "symbol": "XAUUSD", "time": "2025-12-04T10:30:00+00:00", "open": 4199.14, "high": 4201.7, "low": 4197.94, "close": 4201.07, "volume": 2927 }, { "symbol": "XAUUSD", "time": "2025-12-04T10:45:00+00:00", "open": 4201.04, "high": 4201.76, "low": 4196.61, "close": 4197.34, "volume": 2750 }, { "symbol": "XAUUSD", "time": "2025-12-04T11:00:00+00:00", "open": 4197.35, "high": 4206.52, "low": 4197.16, "close": 4202.35, "volume": 3700 }, { "symbol": "XAUUSD", "time": "2025-12-04T11:15:00+00:00", "open": 4202.37, "high": 4204.02, "low": 4197.15, "close": 4199.08, "volume": 3518 }, { "symbol": "XAUUSD", "time": "2025-12-04T11:30:00+00:00", "open": 4199.06, "high": 4202.07, "low": 4197.79, "close": 4200.13, "volume": 2114 }, { "symbol": "XAUUSD", "time": "2025-12-04T11:45:00+00:00", "open": 4200.11, "high": 4200.64, "low": 4197.09, "close": 4198.52, "volume": 2289 }, { "symbol": "XAUUSD", "time": "2025-12-04T12:00:00+00:00", "open": 4198.45, "high": 4201.79, "low": 4193.22, "close": 4200.74, "volume": 3268 }, { "symbol": "XAUUSD", "time": "2025-12-04T12:15:00+00:00", "open": 4200.79, "high": 4201.24, "low": 4192.97, "close": 4194.31, "volume": 3298 }, { "symbol": "XAUUSD", "time": "2025-12-04T12:30:00+00:00", "open": 4194.28, "high": 4194.28, "low": 4188.65, "close": 4192.71, "volume": 3938 }, { "symbol": "XAUUSD", "time": "2025-12-04T12:45:00+00:00", "open": 4192.68, "high": 4193.46, "low": 4188.73, "close": 4190.43, "volume": 4348 }, { "symbol": "XAUUSD", "time": "2025-12-04T13:00:00+00:00", "open": 4190.42, "high": 4192.52, "low": 4185.61, "close": 4187.52, "volume": 5674 }, { "symbol": "XAUUSD", "time": "2025-12-04T13:15:00+00:00", "open": 4187.48, "high": 4196.78, "low": 4185.71, "close": 4195.63, "volume": 4570 }, { "symbol": "XAUUSD", "time": "2025-12-04T13:30:00+00:00", "open": 4195.6, "high": 4195.94, "low": 4187.09, "close": 4191.69, "volume": 5245 }, { "symbol": "XAUUSD", "time": "2025-12-04T13:45:00+00:00", "open": 4191.68, "high": 4198.52, "low": 4188.3, "close": 4198.38, "volume": 4826 }, { "symbol": "XAUUSD", "time": "2025-12-04T14:00:00+00:00", "open": 4198.33, "high": 4206.31, "low": 4198.31, "close": 4204.7, "volume": 4988 }, { "symbol": "XAUUSD", "time": "2025-12-04T14:15:00+00:00", "open": 4204.71, "high": 4210.36, "low": 4202.39, "close": 4208.18, "volume": 4979 }, { "symbol": "XAUUSD", "time": "2025-12-04T14:30:00+00:00", "open": 4208.12, "high": 4213.25, "low": 4193.49, "close": 4200.02, "volume": 7295 }, { "symbol": "XAUUSD", "time": "2025-12-04T14:45:00+00:00", "open": 4200.0, "high": 4208.09, "low": 4196.82, "close": 4201.09, "volume": 7216 }, { "symbol": "XAUUSD", "time": "2025-12-04T15:00:00+00:00", "open": 4201.23, "high": 4203.19, "low": 4191.3, "close": 4202.49, "volume": 7047 }, { "symbol": "XAUUSD", "time": "2025-12-04T15:15:00+00:00", "open": 4202.54, "high": 4206.23, "low": 4200.84, "close": 4205.75, "volume": 5951 }, { "symbol": "XAUUSD", "time": "2025-12-04T15:30:00+00:00", "open": 4205.78, "high": 4210.13, "low": 4204.62, "close": 4206.47, "volume": 5403 }, { "symbol": "XAUUSD", "time": "2025-12-04T15:45:00+00:00", "open": 4206.47, "high": 4208.48, "low": 4202.65, "close": 4207.43, "volume": 5705 }, { "symbol": "XAUUSD", "time": "2025-12-04T16:00:00+00:00", "open": 4207.45, "high": 4215.29, "low": 4206.73, "close": 4210.4, "volume": 5409 }, { "symbol": "XAUUSD", "time": "2025-12-04T16:15:00+00:00", "open": 4210.39, "high": 4219.33, "low": 4209.98, "close": 4216.05, "volume": 4884 }, { "symbol": "XAUUSD", "time": "2025-12-04T16:30:00+00:00", "open": 4216.07, "high": 4216.46, "low": 4207.62, "close": 4210.91, "volume": 4729 }, { "symbol": "XAUUSD", "time": "2025-12-04T16:45:00+00:00", "open": 4210.99, "high": 4216.65, "low": 4210.16, "close": 4215.6, "volume": 4122 }, { "symbol": "XAUUSD", "time": "2025-12-04T17:00:00+00:00", "open": 4215.58, "high": 4216.88, "low": 4209.24, "close": 4211.13, "volume": 4479 }, { "symbol": "XAUUSD", "time": "2025-12-04T17:15:00+00:00", "open": 4211.12, "high": 4213.59, "low": 4208.76, "close": 4211.06, "volume": 3500 }]
        };

        // Update UI
        const trade = rawData.trade;
        document.getElementById('title').innerText = `${trade.type} ${trade.symbol} @ ${trade.open_price}`;
        document.getElementById('details').innerText = `Profit: ${trade.profit} | Time: ${trade.open_time} -> ${trade.close_time}`;

        // Initialize Chart
        const chartOptions = {
            layout: {
                textColor: '#D1D5DB',
                background: { type: 'solid', color: '#111827' }
            },
            grid: {
                vertLines: { color: '#374151' },
                horzLines: { color: '#374151' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
            watermark: {
                visible: true,
                fontSize: 48,
                horzAlign: 'center',
                vertAlign: 'center',
                color: 'rgba(255, 255, 255, 0.1)',
                text: `${trade.symbol} M15`,
            },
        };

        const chart = LightweightCharts.createChart(document.getElementById('chart'), chartOptions);

        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#10B981',
            downColor: '#EF4444',
            borderVisible: false,
            wickUpColor: '#10B981',
            wickDownColor: '#EF4444'
        });

        // --- Data Processing Functions ---

        function generateMockM5(m15Data) {
            const m5Data = [];
            for (const candle of m15Data) {
                const time = new Date(candle.time).getTime() / 1000;
                const O = candle.open;
                const H = candle.high;
                const L = candle.low;
                const C = candle.close;

                // We need 3 candles: c1, c2, c3
                // c1.open = O
                // c3.close = C
                // c2.open = c1.close
                // c3.open = c2.close

                // 1. Determine which candle holds the High and which holds the Low
                const highIdx = Math.floor(Math.random() * 3);
                const lowIdx = Math.floor(Math.random() * 3);

                // 2. Generate Close prices for c1 and c2 (which are also Open for c2 and c3)
                // We want a path from O to C.
                // Let's use a constrained random walk.
                // Target for c1 close ~ O + (C-O)/3
                // Target for c2 close ~ O + 2*(C-O)/3

                const volatility = (H - L) * 0.15; // Allow some swing

                let c1_close = O + (C - O) / 3 + (Math.random() - 0.5) * volatility;
                let c2_close = O + 2 * (C - O) / 3 + (Math.random() - 0.5) * volatility;

                // Clamp closes to be within [L, H] to ensure validity
                c1_close = Math.max(L, Math.min(H, c1_close));
                c2_close = Math.max(L, Math.min(H, c2_close));

                // 3. Construct the 3 candles
                const candles = [
                    { time: time, open: O, close: c1_close },
                    { time: time + 300, open: c1_close, close: c2_close },
                    { time: time + 600, open: c2_close, close: C }
                ];

                // 4. Assign Highs and Lows
                candles.forEach((c, i) => {
                    // Base High/Low from body
                    let h = Math.max(c.open, c.close);
                    let l = Math.min(c.open, c.close);

                    // If this is the designated High candle, force High = H
                    if (i === highIdx) {
                        h = H;
                    } else {
                        // Random high between body top and H
                        // Bias towards body to make it look "normal" unless volatility is high
                        h = h + Math.random() * (H - h) * 0.6;
                    }

                    // If this is the designated Low candle, force Low = L
                    if (i === lowIdx) {
                        l = L;
                    } else {
                        // Random low between L and body bottom
                        l = l - Math.random() * (l - L) * 0.6;
                    }

                    // Safety clamps (shouldn't be needed if logic is right, but good practice)
                    c.high = Math.min(H, h);
                    c.low = Math.max(L, l);
                });

                // 5. Final sanity check: Ensure at least one candle touches H and one touches L
                // (The logic above guarantees it via highIdx/lowIdx, but floating point might drift slightly)
                // We can force it again just to be sure.
                candles[highIdx].high = H;
                candles[lowIdx].low = L;

                m5Data.push(...candles);
            }
            return m5Data;
        }

        // Generate M5 base data from M15
        const baseM5Data = generateMockM5(rawData.candles);

        function resampleData(data, periodMinutes) {
            // Base data is now M5
            if (periodMinutes === 5) {
                return data;
            }

            const resampled = [];
            let currentCandle = null;
            const periodSeconds = periodMinutes * 60;

            for (const candle of data) {
                const candleTime = candle.time; // Already seconds
                // Align to period start
                const periodStart = Math.floor(candleTime / periodSeconds) * periodSeconds;

                if (!currentCandle || currentCandle.time !== periodStart) {
                    if (currentCandle) resampled.push(currentCandle);

                    currentCandle = {
                        time: periodStart,
                        open: candle.open,
                        high: candle.high,
                        low: candle.low,
                        close: candle.close,
                    };
                } else {
                    // Update current candle
                    currentCandle.high = Math.max(currentCandle.high, candle.high);
                    currentCandle.low = Math.min(currentCandle.low, candle.low);
                    currentCandle.close = candle.close;
                }
            }
            if (currentCandle) resampled.push(currentCandle);
            return resampled;
        }

        function updateChart(period) {
            const periodName = period == 5 ? 'M5' : period == 15 ? 'M15' : period == 60 ? 'H1' : 'H4';

            // Update Watermark
            chart.applyOptions({
                watermark: {
                    text: `${trade.symbol} ${periodName}`,
                }
            });

            // Resample Data from baseM5Data
            const processedData = resampleData(baseM5Data, period);

            candlestickSeries.setData(processedData);

            // Re-draw Lines (Extend to full range)
            const startTime = processedData[0].time;
            const endTime = processedData[processedData.length - 1].time;

            updateLines(startTime, endTime);

            chart.timeScale().fitContent();
        }

        // --- Line Series Management ---
        let entryLine, tpLine, slLine;

        function initLines() {
            entryLine = chart.addLineSeries({
                color: '#3B82F6',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                title: `Entry (${trade.type})`,
            });

            if (trade.tp > 0) {
                tpLine = chart.addLineSeries({
                    color: '#10B981',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    title: 'TP',
                });
            }

            if (trade.sl > 0) {
                slLine = chart.addLineSeries({
                    color: '#EF4444',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    title: 'SL',
                });
            }
        }

        function updateLines(startTime, endTime) {
            entryLine.setData([
                { time: startTime, value: trade.open_price },
                { time: endTime, value: trade.open_price }
            ]);

            if (tpLine) {
                tpLine.setData([
                    { time: startTime, value: trade.tp },
                    { time: endTime, value: trade.tp }
                ]);
            }

            if (slLine) {
                slLine.setData([
                    { time: startTime, value: trade.sl },
                    { time: endTime, value: trade.sl }
                ]);
            }
        }

        // Initialize
        initLines();
        updateChart(15); // Default M15

        // Event Listener
        document.getElementById('timeframe').addEventListener('change', (e) => {
            updateChart(parseInt(e.target.value));
        });
    </script>
</body>

</html>